<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <title>Editor</title>
    <link rel="stylesheet" href="https://unpkg.com/blaze@4.0.0-6/scss/dist/blaze.min.css" />
    <link rel="stylesheet" href="{% static "css/editor.css" %}" />

    <script src="{% static "js/storage.js" %}" type="text/javascript" charset="utf-8"></script>

    <script src="{% static "jquery/jquery-3.3.1.min.js" %}" type="text/javascript" charset="utf-8"></script>
    <script src="{% static "ace/ace.js" %}" type="text/javascript" charset="utf-8"></script>

    <script type="text/javascript">
        let editor;
        let csrftoken;
        let settings;
        $(document).ready(() => {

            settings = storage.get_values();
            $("#editor_control_language").val(settings.language);
            $("#editor_control_theme").val(settings.theme);
            $("#editor_control_size").val(settings.font_size);
            $("#editor_control_keybindings").val(settings.controls);

            let initial_language = settings.language;
            if (initial_language === "c" || initial_language === "cpp") {
                initial_language = "c_cpp";
            }

            editor = ace.edit("editor");
            editor.setTheme("ace/theme/" + settings.theme);
            editor.session.setMode("ace/mode/" + initial_language);
            editor.setFontSize(parseInt(settings.font_size));
            editor.setKeyboardHandler(settings.controls);

            // Handler: run the code
            $("#editor_run_btn").click(() => {
                let text = editor.getValue();
                let language = $("#editor_control_language").val();
                let filename = $("#editor_run_filename").val();
                let flags = $("#editor_run_args").val();
                $.ajax({
                    type: "POST",
                    url: "{% url 'editor' %}",
                    data: {
                        "text": text,
                        "language": language,
                        "filename": filename,
                        "flags": flags
                    },
                    success: (result) => {
                        let output = $("#output");
                        $('html, body').animate({
                            scrollTop: output.offset().top
                        }, 1500);
                        if (output.html() === "") {
                            output.html(result);
                        } else {
                            output.prepend(result + "<br /><hr />");
                        }
                    }
                });
            });

            // Handler: change language
            $("#editor_control_language").change((event) => {
                let language = $(event.target).val();
                let ace_language;
                switch (language) {
                    case "c":
                    case "cpp":
                        ace_language = "c_cpp";
                        break;
                    case "java":
                        ace_language = "java";
                        break;
                    case "python":
                        ace_language = "python";
                        break;
                }
                editor.session.setMode("ace/mode/" + ace_language);
                storage.set_values({language: language});
            });

            // Handler: change font size
            $("#editor_control_size").change((event) => {
                try {
                    let font_size = parseInt($(event.target).val())
                    editor.setFontSize(font_size);
                    storage.set_values({font_size: font_size});
                } catch (e) {}
            });

            // Handler: change theme
            $("#editor_control_theme").change((event) => {
                let theme = $(event.target).val();
                editor.setTheme("ace/theme/" + theme);
                storage.set_values({theme: theme});
            });

            // Handler: change keybindings
            $("#editor_control_keybindings").change((event) => {
                let controls = $(event.target).val();
                editor.setKeyboardHandler(controls);
                storage.set_values({controls: controls});
            });

            let csrfSafeMethod = (method) =>{
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            };
            $.ajaxSetup({
                beforeSend: (xhr, settings) => {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });
        });
    </script>
</head>
<body>

    <ul class="c-nav c-nav--inline">
        <a href="{% url 'editor' %}"><li class="c-nav__item">Editor</li></a>
        <a href="{% url 'files' %}"><li class="c-nav__item">Files</li></a>
        <a href="{% url 'profile' %}"><li class="c-nav__item">Profile</li></a>
        <a href="{% url 'logout' %}"><li class="c-nav__item c-nav__item--right">Logout</li></a>
        {% if user.is_authenticated %}
                <a><li class="c-nav__item c-nav__item--right">Welcome, {{ user.username }}</li></a>
            {% else %}
                <a href="{% url 'login' %}"><li class="c-nav__item c-nav__item--right">Login/Register</li></a>
        {% endif %}
    </ul>

    <div id="body">

        <div class="c-card">
            <div class="c-card__item c-card__item--success o-media">
                <div class="o-media__body">
                    <h2 class="c-heading">Welcome to the code editor</h2>
                    <p class="c-paragraph">Some intro text would go here</p>
                </div>
            </div>
        </div>

        <div class="c-input-group" id="editor_controls">
            <div class="o-field">
                <label class="c-field">
                    Language:
                    <select class="c-field" id="editor_control_language">
                        <option value="c">C</option>
                        <option value="cpp">C++</option>
                        <option value="java">Java</option>
                        <option value="python">Python</option>
                    </select>
                </label>
            </div>
            <div class="o-field">
                <label class="c-field">
                    Theme:
                    <select class="c-field" id="editor_control_theme">
                        <optgroup label="Dark">
                            <option value="ambiance">Ambiance</option>
                            <option value="chaos">Chaos</option>
                            <option value="clouds_midnight">Clouds Midnight</option>
                            <option value="dracula">Dracula</option>
                            <option value="cobalt">Cobalt</option>
                            <option value="gruvbox">Gruvbox</option>
                            <option value="idle_fingers">Idle Fingers</option>
                            <option value="kr_theme">KR Theme</option>
                            <option value="merbivore">Merbivore</option>
                            <option value="merbivore_soft">Merbivore Soft</option>
                            <option value="mono_industrial">Mono Industrial</option>
                            <option value="monokai">Monokai</option>
                            <option value="pastel_on_dark">Pastel on Dark</option>
                            <option value="solarized_dark">Solarized Dark</option>
                            <option value="terminal">Terminal</option>
                            <option value="tomorrow_night">Tomorrow Night</option>
                            <option value="tomorrow_night_blue">Tomorrow Night Blue</option>
                            <option value="tomorrow_night_bright">Tomorrow Night Bright</option>
                            <option value="tomorrow_night_eighties">Tomorrow Night 80s</option>
                            <option value="twilight">Twilight</option>
                            <option value="vibrant_ink">Vibrant Ink</option>
                        </optgroup>
                        <optgroup label="Light">
                            <option value="chrome">Chrome</option>
                            <option value="clouds">Clouds</option>
                            <option value="crimson_editor">Crimson Editor</option>
                            <option value="dawn">Dawn</option>
                            <option value="dreamweaver">Dreamweaver</option>
                            <option value="eclipse">Eclipse</option>
                            <option value="github">GitHub</option>
                            <option value="iplastic">Iplastic</option>
                            <option value="katzenmilch">Katzenmilch</option>
                            <option value="kuroir">Kuroir</option>
                            <option value="solarized_light">Solarized Light</option>
                            <option value="sqlserver">SQL Server</option>
                            <option value="textmate">TextMate</option>
                            <option value="tomorrow">Tomorrow</option>
                            <option value="xcode">XCode</option>
                        </optgroup>
                    </select>
                </label>
            </div>
            <div class="o-field">
                <label class="c-field">
                    Font size:
                    <input type="number" size="2" maxlength="2" min="1" class="c-field" value="12" id="editor_control_size" />
                </label>
            </div>
            <div class="o-field">
                <label class="c-field">
                    Controls:
                    <select class="c-field" id="editor_control_keybindings">
                        <option value="">Normal</option>
                        <option value="ace/keyboard/vim">Vim</option>
                        <option value="ace/keyboard/emacs">Emacs</option>
                    </select>
                </label>
            </div>
            <button class="c-button c-button--info" style="padding: 15px">Share</button>
            <button class="c-button c-button--error" style="padding: 15px">Load</button>
            <button class="c-button c-button--success" style="padding: 15px">Save</button>
        </div>
        <div id="editor">// write your code here!</div>

        <div id="editor_run" class="c-input-group">
            <div class="o-field">
                <input type="text" class="c-field" placeholder="(optional) filename" name="editor_run_filename" id="editor_run_filename"/>
            </div>
            <div class="o-field">
                <input type="text" class="c-field" placeholder="(optional) command line arguments" name="editor_run_args" id="editor_run_args"/>
            </div>
            <input type="button" class="c-button c-button--success" name="editor_run_btn" id="editor_run_btn" value="Run program!" />
        </div>

        <p id="output" name="output"></p>

    </div>

    {% csrf_token %}
    <script type="text/javascript">
        // using jQuery
        csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
    </script>
</body>
</html>